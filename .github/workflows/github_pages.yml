name: deploy-book

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy-book:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies (requirements.txt)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # ensure jupyter-book is installed even if not in requirements.txt
          pip install -U jupyter-book

      - name: Show repo root (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: cache executed notebooks
        uses: actions/cache@v4
        with:
          path: _build/.jupyter_cache
          key: jupyter-book-cache-${{ hashFiles('requirements.txt') }}

      - name: Build the book
        run: |
          set -euxo pipefail
          # build the book; adjust command if your sources sit in a subfolder
          jupyter-book build .
      
      - name: Show _build contents (debug)
        run: |
          echo "----- ls -la _build -----"
          ls -la _build || true
          echo "----- recursive find for html dirs under _build -----"
          find _build -maxdepth 5 -type d -name 'html' -print || true
          echo "----- all files under _build -----"
          find _build -maxdepth 5 -print || true

      - name: Upload artifact (pages)
        uses: actions/upload-pages-artifact@v3
        with:
          # keep _build/html as default, but if your build wrote elsewhere (see above debug)
          path: _build/html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
